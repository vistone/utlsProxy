# 版本管理说明

本文档说明项目的版本管理流程和自动发布机制。

## 版本号格式

项目使用语义化版本号格式：`v主版本.次版本.修订版本`

- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订版本号**：向下兼容的问题修正

示例：`v1.0.0` → `v1.0.1` → `v1.1.0` → `v2.0.0`

## 版本文件

项目使用两个文件管理版本号：

1. **VERSION文件**：根目录下的 `VERSION` 文件，存储当前版本号
2. **config/config.toml**：配置文件中的 `Version` 字段，自动同步

## 自动发布流程

### GitHub Actions自动发布

项目配置了GitHub Actions workflow (`.github/workflows/release.yml`)，当推送到 `main` 分支时会自动：

1. ✅ 检测当前版本号（从VERSION文件或config.toml）
2. ✅ 自动增加小版本号（patch: v1.0.0 → v1.0.1）
3. ✅ 更新VERSION文件和config.toml
4. ✅ 创建Git标签
5. ✅ 创建GitHub Release

**触发条件**：
- 推送到 `main` 分支
- 提交信息中不包含 `[skip release]`

**跳过自动发布**：
```bash
git commit -m "更新文档 [skip release]"
```

## 手动发布流程

### 方式1：使用一键脚本（推荐）

```bash
# 自动增加版本号、提交、推送、创建Release
./scripts/commit_and_release.sh "你的提交信息"
```

### 方式2：分步执行

```bash
# 1. 增加版本号
./scripts/bump_version.sh patch  # 或 minor, major

# 2. 提交更改
git add VERSION config/config.toml
git commit -m "Bump version to $(cat VERSION)"

# 3. 推送
git push origin main

# 4. 创建Release（如果安装了GitHub CLI）
./scripts/create_release.sh
```

### 方式3：手动创建GitHub Release

1. 访问：https://github.com/vistone/utlsProxy/releases/new
2. 选择标签：选择已推送的Git标签（如 `v1.0.1`）
3. 填写Release标题：`Release v1.0.1`
4. 填写Release说明：描述本次更新的内容
5. 点击"Publish release"

## 版本管理脚本

### bump_version.sh

自动增加版本号。

```bash
# 增加小版本号（默认）
./scripts/bump_version.sh patch

# 增加中版本号
./scripts/bump_version.sh minor

# 增加大版本号
./scripts/bump_version.sh major
```

### create_release.sh

创建GitHub Release（需要GitHub CLI）。

```bash
# 使用VERSION文件中的版本号
./scripts/create_release.sh

# 指定版本号和提交信息
./scripts/create_release.sh v1.0.1 "修复热连接池问题"
```

### commit_and_release.sh

一键提交并发布。

```bash
# 使用默认提交信息
./scripts/commit_and_release.sh

# 指定提交信息
./scripts/commit_and_release.sh "修复热连接池白名单问题"

# 指定版本类型
./scripts/commit_and_release.sh "重大更新" minor
```

## 版本号更新位置

版本号会在以下位置自动更新：

1. ✅ `VERSION` 文件
2. ✅ `config/config.toml` 中的 `[ServerConfig]` 段

## 版本历史

查看所有版本：

```bash
# 查看Git标签
git tag -l

# 查看GitHub Releases
# 访问: https://github.com/vistone/utlsProxy/releases
```

## 注意事项

1. **版本格式**：必须遵循 `v主版本.次版本.修订版本` 格式
2. **Git标签**：每次发布都会创建对应的Git标签
3. **自动同步**：VERSION文件和config.toml会自动同步
4. **GitHub CLI**：使用 `create_release.sh` 需要安装GitHub CLI (`gh`)
5. **权限**：创建Release需要GitHub token权限

## 安装GitHub CLI（可选）

如果需要使用脚本自动创建GitHub Release：

```bash
# macOS
brew install gh

# Linux
# 参考: https://github.com/cli/cli/blob/trunk/docs/install_linux.md

# 登录
gh auth login
```

## 示例工作流

### 日常提交（自动发布）

```bash
# 1. 修改代码
# ... 编辑文件 ...

# 2. 提交（GitHub Actions会自动增加版本并创建Release）
git add .
git commit -m "修复热连接池问题"
git push origin main

# GitHub Actions会自动：
# - 增加版本号 v1.0.1 → v1.0.2
# - 创建Git标签
# - 创建GitHub Release
```

### 跳过自动发布

```bash
# 提交文档更新，不创建Release
git commit -m "更新文档 [skip release]"
git push origin main
```

### 手动控制版本类型

```bash
# 需要增加中版本号时
./scripts/commit_and_release.sh "新增功能" minor

# 需要增加大版本号时
./scripts/commit_and_release.sh "重大更新" major
```

