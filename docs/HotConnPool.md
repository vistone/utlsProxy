# 热连接池工作流程 (HotConnPool)

本文档详细介绍了热连接池的完整工作流程，包括初始化、连接管理、预热、IP健康管理等核心流程。

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    热连接池 (HotConnPool)                    │
├─────────────────────────────────────────────────────────────┤
│  连接池管理                                                  │
│  ├─ 健康连接池 (healthyConns)                               │
│  └─ 不健康连接池 (unhealthyConns)                          │
├─────────────────────────────────────────────────────────────┤
│  依赖组件                                                    │
│  ├─ DomainMonitor (域名IP监控器)                            │
│  ├─ IPAccessController (IP访问控制器/黑白名单)              │
│  ├─ LocalIPv4Pool (本地IPv4地址池)                         │
│  └─ LocalIPv6Pool (本地IPv6地址池)                          │
├─────────────────────────────────────────────────────────────┤
│  目标IP管理                                                  │
│  ├─ targetIPv6List (目标IPv6列表)                          │
│  └─ targetIPv4List (目标IPv4列表)                           │
└─────────────────────────────────────────────────────────────┘
```

## 完整工作流程

### 阶段1：初始化阶段

```
1. 加载配置
   └─ 从 config.toml 读取配置参数

2. 创建本地IP池
   ├─ LocalIPv4Pool: 创建IPv4地址池（备用）
   └─ LocalIPv6Pool: 创建IPv6地址池（优先，如果环境支持）

3. 初始化连接池
   ├─ 创建健康连接通道 (healthyConns)
   ├─ 创建不健康连接通道 (unhealthyConns)
   ├─ 设置TLS指纹配置
   └─ 初始化UTlsClient用于健康检查

4. 刷新目标IP列表
   └─ 从DomainMonitor获取域名的IP列表（IPv4 + IPv6）

5. 启动后台任务
   ├─ IP刷新任务 (定期从DomainMonitor获取最新IP)
   ├─ 黑名单测试任务 (定期测试黑名单IP并恢复)
   └─ 连接清理任务 (清理超时连接)
```

### 阶段2：预热阶段 (Warmup)

```
1. 刷新IP列表
   └─ 从DomainMonitor获取最新的IP列表

2. 过滤IP
   ├─ 获取所有IPv6地址
   ├─ 获取所有IPv4地址
   └─ 过滤：只保留白名单中的IP

3. 并发预热（使用信号量控制并发数）
   ├─ 优先预热IPv6连接
   │   ├─ 获取IPv6本地IP
   │   ├─ 创建连接（IPv6本地IP + IPv6目标IP）
   │   ├─ 发送健康检查请求
   │   └─ 根据状态码更新黑白名单：
   │       ├─ 200 → 加入白名单
   │       └─ 403 → 加入黑名单
   │
   └─ 预热IPv4连接（作为备用）
       ├─ 获取IPv4本地IP
       ├─ 创建连接（IPv4本地IP + IPv4目标IP）
       ├─ 发送健康检查请求
       └─ 根据状态码更新黑白名单

4. 预热完成
   └─ 记录预热结果统计
```

### 阶段3：连接获取流程 (GetConn)

```
优先级顺序：

1. 尝试从健康连接池获取
   └─ 如果成功，直接返回连接

2. 尝试从不健康连接池获取
   └─ 如果成功，返回连接（可以尝试使用）

3. 创建新连接（所有池都为空时）
   ├─ 获取本地IP（IPv6优先）
   │   ├─ 优先：从LocalIPv6Pool获取IPv6地址
   │   └─ 降级：从LocalIPv4Pool获取IPv4地址
   │
   ├─ 获取目标IP（IPv6优先）
   │   ├─ 优先：从targetIPv6List获取IPv6地址（白名单过滤）
   │   └─ 降级：从targetIPv4List获取IPv4地址（白名单过滤）
   │
   └─ 连接策略（按优先级尝试）
       ├─ 策略1：IPv6本地IP + IPv6目标IP（最优）
       │   └─ 如果失败，继续下一个策略
       │
       ├─ 策略2：IPv6本地IP + IPv4目标IP
       │   └─ 注意：使用系统默认路由（不绑定本地IP）
       │
       └─ 策略3：IPv4本地IP + IPv4目标IP（最终降级）
           └─ 如果失败，返回错误

4. 返回连接
   └─ 返回创建的连接或错误
```

### 阶段4：连接归还流程 (ReturnConn)

```
1. 验证连接
   └─ 检查连接是否为nil

2. 根据状态码分类
   ├─ 200 (成功)
   │   ├─ 放入健康连接池 (healthyConns)
   │   └─ 如果健康池已满，关闭连接
   │
   ├─ 403 (被封)
   │   ├─ 记录目标IP（如果可能）
   │   ├─ 将IP加入黑名单
   │   ├─ 放入不健康连接池 (unhealthyConns)
   │   └─ 如果池已满，关闭连接
   │
   └─ 其他错误
       ├─ 放入不健康连接池
       └─ 如果池已满，关闭连接
```

### 阶段5：后台任务流程

#### 5.1 IP刷新任务

```
循环执行（每IPRefreshInterval分钟）：

1. 从DomainMonitor获取最新IP列表
   └─ 调用 GetDomainPool(domain)

2. 提取IP地址
   ├─ 提取IPv6地址列表
   └─ 提取IPv4地址列表

3. 更新内部IP列表
   ├─ 加锁保护
   ├─ 更新targetIPv6List
   └─ 更新targetIPv4List

4. 记录日志
   └─ 输出IP列表统计信息
```

#### 5.2 黑名单测试任务

```
循环执行（每BlacklistTestInterval分钟）：

1. 获取所有黑名单IP
   └─ 调用 ipAccessControl.GetBlockedIPs()

2. 如果没有黑名单IP，跳过

3. 并发测试每个黑名单IP
   ├─ 使用信号量控制并发数
   ├─ 发送健康检查请求
   └─ 检查响应状态码：
       ├─ 200 (恢复成功)
       │   ├─ 从黑名单移除
       │   ├─ 加入白名单
       │   └─ 记录恢复日志
       │
       └─ 其他 (仍被封)
           └─ 保持黑名单状态

4. 等待所有测试完成
```

#### 5.3 连接清理任务

```
循环执行（每分钟）：

1. 检查连接超时
   └─ 清理空闲时间超过IdleTimeout的连接

2. 清理逻辑
   ├─ 遍历健康连接池
   ├─ 检查每个连接的空闲时间
   └─ 关闭超时连接

注意：当前实现中，由于连接没有时间戳，此功能为框架预留
```

### 阶段6：关闭流程 (Close)

```
1. 发送停止信号
   └─ 关闭stopChan，通知所有后台任务停止

2. 等待后台任务结束
   └─ 使用WaitGroup等待所有goroutine完成

3. 清理连接
   ├─ 清空健康连接池
   │   └─ 关闭所有连接
   │
   └─ 清空不健康连接池
       └─ 关闭所有连接

4. 关闭通道
   ├─ 关闭healthyConns
   └─ 关闭unhealthyConns

5. 关闭本地IP池
   ├─ 关闭LocalIPv4Pool
   └─ 关闭LocalIPv6Pool

6. 完成
   └─ 记录关闭日志
```

## 详细流程图

### 连接创建流程图

```
开始创建连接
    ↓
获取本地IP（IPv6优先）
    ├─ 有IPv6本地IP → 使用IPv6
    └─ 无IPv6 → 使用IPv4
    ↓
获取目标IP（IPv6优先）
    ├─ 有IPv6目标IP → 优先使用IPv6
    └─ 无IPv6 → 使用IPv4
    ↓
策略1：IPv6本地IP + IPv6目标IP
    ├─ 成功 → 返回连接
    └─ 失败 → 继续
    ↓
策略2：IPv6本地IP + IPv4目标IP（系统默认路由）
    ├─ 成功 → 返回连接
    └─ 失败 → 继续
    ↓
策略3：IPv4本地IP + IPv4目标IP
    ├─ 成功 → 返回连接
    └─ 失败 → 返回错误
```

### 预热流程图

```
开始预热
    ↓
刷新IP列表
    ↓
过滤白名单IP
    ├─ IPv6列表
    └─ IPv4列表
    ↓
并发预热（信号量控制）
    ├─ 预热IPv6连接
    │   ├─ 创建连接
    │   ├─ 健康检查
    │   └─ 更新黑白名单
    │
    └─ 预热IPv4连接
        ├─ 创建连接
        ├─ 健康检查
        └─ 更新黑白名单
    ↓
等待所有预热完成
    ↓
预热完成
```

### 黑名单恢复流程图

```
定时触发（每N分钟）
    ↓
获取所有黑名单IP
    ↓
并发测试（信号量控制）
    ├─ 发送健康检查请求
    ├─ 检查状态码
    │   ├─ 200 → 恢复成功
    │   │   ├─ 从黑名单移除
    │   │   └─ 加入白名单
    │   │
    │   └─ 其他 → 保持黑名单
    │
    └─ 记录日志
    ↓
等待所有测试完成
```

## 关键设计点

### 1. IPv6优先策略

- 本地IP：优先使用IPv6，失败则降级到IPv4
- 目标IP：优先使用IPv6，失败则降级到IPv4
- 连接策略：IPv6+IPv6 > IPv6+IPv4 > IPv4+IPv4

### 2. IP健康管理

- 白名单：返回200的IP自动加入白名单
- 黑名单：返回403的IP自动加入黑名单
- 自动恢复：黑名单IP定期测试，恢复后自动移回白名单

### 3. 连接池管理

- 健康池：优先使用，包含已验证可用的连接
- 不健康池：备用，包含可能有问题但可尝试的连接
- 动态创建：池为空时自动创建新连接

### 4. 并发安全

- 使用channel实现连接队列（并发安全）
- 使用RWMutex保护IP列表
- 使用WaitGroup管理后台任务

### 5. 资源管理

- 连接数限制：MaxConns控制最大连接数
- 空闲超时：IdleTimeout自动清理超时连接
- 优雅关闭：Close方法确保所有资源正确释放

## 使用示例

```go
// 1. 创建连接池
pool, err := src.NewDomainHotConnPool(config)
if err != nil {
    log.Fatalf("创建连接池失败: %v", err)
}
defer pool.Close()

// 2. 预热
if err := pool.Warmup(); err != nil {
    log.Printf("预热失败: %v", err)
}

// 3. 使用连接
conn, err := pool.GetConn()
if err != nil {
    log.Fatalf("获取连接失败: %v", err)
}

// 4. 使用连接发送请求
// ... 使用conn发送HTTP请求 ...

// 5. 归还连接
statusCode := 200 // 从响应中获取
pool.ReturnConn(conn, statusCode)
```

## 状态转换图

```
IP状态转换：
    ┌─────────┐
    │  未知   │ (初始状态)
    └────┬────┘
         │
         │ 预热/使用
         ↓
    ┌─────────┐      200      ┌─────────┐
    │  测试中  │ ────────────→ │  白名单  │
    └─────────┘                └────┬────┘
         │                          │
         │ 403                      │ 使用
         ↓                          ↓
    ┌─────────┐                ┌─────────┐
    │  黑名单  │                │  使用中  │
    └────┬────┘                └─────────┘
         │
         │ 定时测试
         │ 返回200
         ↓
    ┌─────────┐
    │  白名单  │ (恢复)
    └─────────┘

连接状态转换：
    ┌─────────┐
    │  创建   │
    └────┬────┘
         │
         │ 健康检查
         ↓
    ┌─────────┐      200      ┌──────────┐
    │  测试中  │ ────────────→ │ 健康连接池│
    └─────────┘                └────┬─────┘
         │                          │
         │ 403/错误                  │ GetConn
         ↓                          ↓
    ┌──────────┐               ┌─────────┐
    │不健康连接池│               │  使用中  │
    └────┬─────┘               └────┬────┘
         │                         │
         │ 定时清理                 │ ReturnConn
         ↓                         ↓
    ┌─────────┐               ┌─────────┐
    │  关闭   │               │ 归还连接 │
    └─────────┘               └─────────┘
```

## 性能优化点

1. 连接复用：优先使用池中的连接，减少创建开销
2. 并发预热：使用信号量控制并发数，避免资源耗尽
3. 异步刷新：后台任务异步更新IP列表，不阻塞主流程
4. 智能降级：IPv6失败时自动降级，提高成功率
5. 健康管理：自动管理IP健康状态，减少无效连接

## 注意事项

1. 连接协议匹配：IPv4本地IP只能连接IPv4目标IP，IPv6本地IP优先连接IPv6目标IP
2. 黑白名单优先级：黑名单优先于白名单，即使IP同时在两个名单中也会被拒绝
3. 连接超时：连接创建和健康检查都有超时设置，避免长时间阻塞
4. 资源清理：使用defer确保连接池正确关闭，避免资源泄漏
5. 并发安全：所有共享状态都使用适当的锁保护

