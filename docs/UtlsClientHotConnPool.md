# 热连接池 (UtlsClientHotConnPool)

本文档详细介绍了热连接池的完整工作流程，包括初始化、连接管理、预热、IP健康管理等核心流程。

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│              热连接池 (UtlsClientHotConnPool)                 │
├─────────────────────────────────────────────────────────────┤
│  连接池管理（使用连接元数据）                                 │
│  ├─ 健康连接池 (healthyConns: chan *connMetadata)           │
│  └─ 不健康连接池 (unhealthyConns: chan *connMetadata)      │
├─────────────────────────────────────────────────────────────┤
│  连接元数据 (connMetadata)                                   │
│  ├─ conn: UTLS连接                                          │
│  ├─ targetIP: 目标IP地址                                    │
│  ├─ localIP: 本地绑定IP地址                                 │
│  ├─ createdAt: 连接创建时间                                 │
│  └─ lastUsed: 最后使用时间                                  │
├─────────────────────────────────────────────────────────────┤
│  依赖组件                                                    │
│  ├─ DomainMonitor (域名IP监控器)                            │
│  ├─ IPAccessController (IP访问控制器/黑白名单)              │
│  ├─ LocalIPv4Pool (本地IPv4地址池)                         │
│  └─ LocalIPv6Pool (本地IPv6地址池)                          │
├─────────────────────────────────────────────────────────────┤
│  目标IP管理                                                  │
│  ├─ targetIPv6List (目标IPv6列表)                          │
│  └─ targetIPv4List (目标IPv4列表)                           │
└─────────────────────────────────────────────────────────────┘
```

## 设计初衷

热连接池的设计初衷：
1. **系统启动时黑白名单为空**：初始状态白名单和黑名单都是空的
2. **预热测试所有IP**：从 RemoteDomainIPPool 获取域名的所有IP（IPv4和IPv6）
3. **通过预热填充黑白名单**：
   - 状态码 **200** 的IP → 加入**白名单**
   - 状态码 **403** 的IP → 加入**黑名单**
   - 其他状态码 → 放入不健康连接池
4. **预热成功后建立热连接池**：成功的连接放入连接池，供后续复用

## 完整工作流程

### 阶段1：初始化阶段

```
1. 加载配置
   └─ 从 config.toml 读取配置参数

2. 创建本地IP池
   ├─ LocalIPv4Pool: 创建IPv4地址池（备用）
   └─ LocalIPv6Pool: 创建IPv6地址池（优先，如果环境支持）

3. 初始化连接池
   ├─ 创建健康连接通道 (healthyConns: chan *connMetadata)
   ├─ 创建不健康连接通道 (unhealthyConns: chan *connMetadata)
   ├─ 设置TLS指纹配置
   └─ 初始化UTlsClient用于健康检查

4. 刷新目标IP列表
   └─ 从DomainMonitor获取域名的IP列表（IPv4 + IPv6）

5. 启动后台任务
   ├─ IP刷新任务 (定期从DomainMonitor获取最新IP)
   ├─ 黑名单测试任务 (定期测试黑名单IP并恢复)
   └─ 连接清理任务 (清理超时连接)
```

### 阶段2：预热阶段 (Warmup)

```
1. 刷新IP列表
   └─ 从DomainMonitor获取最新的IP列表

2. 获取所有IP（关键：不进行白名单过滤）
   ├─ 获取所有IPv6地址（直接使用，不过滤）
   ├─ 获取所有IPv4地址（直接使用，不过滤）
   └─ 原因：系统启动时白名单为空，需要通过预热来填充

3. 并发预热（使用信号量控制并发数）
   ├─ 优先预热IPv6连接
   │   ├─ 获取IPv6本地IP
   │   ├─ 创建连接（跳过白名单检查：skipWhitelistCheck=true）
   │   ├─ 发送健康检查请求
   │   └─ 根据状态码更新黑白名单：
   │       ├─ 200 → 加入白名单，连接放入健康池
   │       ├─ 403 → 加入黑名单，关闭连接
   │       └─ 其他 → 连接放入不健康池
   │
   └─ 预热IPv4连接（作为备用）
       ├─ 获取IPv4本地IP
       ├─ 创建连接（跳过白名单检查）
       ├─ 发送健康检查请求
       └─ 根据状态码更新黑白名单

4. 预热完成
   └─ 白名单和黑名单已填充，连接池中有可用的热连接
```

### 阶段3：连接获取流程 (GetConn)

```
优先级顺序：

1. 尝试从健康连接池获取
   ├─ 获取连接元数据 (connMetadata)
   ├─ 更新 lastUsed 时间戳
   └─ 返回连接

2. 尝试从不健康连接池获取
   ├─ 获取连接元数据
   ├─ 更新 lastUsed 时间戳
   └─ 返回连接

3. 创建新连接（所有池都为空时）
   ├─ 获取本地IP（IPv6优先）
   │   ├─ 优先：从LocalIPv6Pool获取IPv6地址
   │   └─ 降级：从LocalIPv4Pool获取IPv4地址
   │
   ├─ 获取目标IP（IPv6优先，需要检查白名单）
   │   ├─ 优先：从targetIPv6List获取IPv6地址（白名单过滤）
   │   └─ 降级：从targetIPv4List获取IPv4地址（白名单过滤）
   │
   └─ 连接策略（按优先级尝试，需要检查白名单）
       ├─ 策略1：IPv6本地IP + IPv6目标IP（最优）
       │   └─ 如果失败，继续下一个策略
       │
       ├─ 策略2：IPv6本地IP + IPv4目标IP
       │   └─ 注意：使用系统默认路由（不绑定本地IP）
       │
       └─ 策略3：IPv4本地IP + IPv4目标IP（最终降级）
           └─ 如果失败，返回错误

4. 返回连接
   └─ 返回创建的连接或错误
```

### 阶段4：连接归还流程 (ReturnConn)

```
1. 验证连接
   └─ 检查连接是否为nil

2. 从连接获取IP信息
   ├─ 从连接的 RemoteAddr() 获取目标IP
   └─ 从连接的 LocalAddr() 获取本地IP

3. 创建连接元数据
   └─ 包含连接、目标IP、本地IP和时间戳

4. 根据状态码分类
   ├─ 200 (成功)
   │   ├─ 将IP加入白名单（如果目标IP可用）
   │   ├─ 放入健康连接池 (healthyConns)
   │   └─ 如果健康池已满，关闭连接
   │
   ├─ 403 (被封)
   │   ├─ 将IP加入黑名单（如果目标IP可用）
   │   └─ 关闭连接（不放入池中）
   │
   └─ 其他错误
       ├─ 放入不健康连接池
       └─ 如果池已满，关闭连接
```

### 阶段5：后台任务流程

#### 5.1 IP刷新任务

```
循环执行（每IPRefreshInterval分钟）：

1. 从DomainMonitor获取最新IP列表
   └─ 调用 GetDomainPool(domain)

2. 提取IP地址
   ├─ 提取IPv6地址列表
   └─ 提取IPv4地址列表

3. 更新内部IP列表
   ├─ 加锁保护
   ├─ 更新targetIPv6List
   └─ 更新targetIPv4List

4. 记录日志
   └─ 输出IP列表统计信息
```

#### 5.2 黑名单测试任务

```
循环执行（每BlacklistTestInterval分钟）：

1. 获取所有黑名单IP
   └─ 调用 ipAccessControl.GetBlockedIPs()

2. 如果没有黑名单IP，跳过

3. 并发测试每个黑名单IP
   ├─ 使用信号量控制并发数
   ├─ 发送健康检查请求
   └─ 检查响应状态码：
       ├─ 200 (恢复成功)
       │   ├─ 从黑名单移除
       │   ├─ 加入白名单
       │   └─ 记录恢复日志
       │
       └─ 其他 (仍被封)
           └─ 保持黑名单状态

4. 等待所有测试完成
```

#### 5.3 连接清理任务

```
循环执行（每分钟）：

1. 检查连接超时
   └─ 清理空闲时间超过IdleTimeout的连接

2. 清理逻辑
   ├─ 遍历健康连接池
   ├─ 检查每个连接的 lastUsed 时间戳
   ├─ 如果 now - lastUsed > IdleTimeout，关闭连接
   └─ 否则放回池中

3. 清理不健康连接池
   └─ 同样的逻辑
```

### 阶段6：关闭流程 (Close)

```
1. 发送停止信号
   └─ 关闭stopChan，通知所有后台任务停止

2. 等待后台任务结束
   └─ 使用WaitGroup等待所有goroutine完成

3. 清理连接
   ├─ 清空健康连接池
   │   └─ 关闭所有连接
   │
   └─ 清空不健康连接池
       └─ 关闭所有连接

4. 关闭通道
   ├─ 关闭healthyConns
   └─ 关闭unhealthyConns

5. 关闭本地IP池
   ├─ 关闭LocalIPv4Pool
   └─ 关闭LocalIPv6Pool

6. 完成
   └─ 记录关闭日志
```

## 关键设计点

### 1. 预热阶段不检查白名单

- **设计初衷**：系统启动时白名单为空，需要通过预热来填充
- **实现**：`Warmup()` 直接使用所有IP，`createConnection()` 使用 `skipWhitelistCheck=true`
- **效果**：预热可以测试所有IP，根据结果填充黑白名单

### 2. 连接元数据管理

- **connMetadata 结构**：包含连接、目标IP、本地IP和时间戳
- **优势**：
  - 可以追踪每个连接对应的IP
  - 支持空闲连接清理（基于 lastUsed）
  - ReturnConn 时可以更新黑白名单

### 3. IPv6优先策略

- 本地IP：优先使用IPv6，失败则降级到IPv4
- 目标IP：优先使用IPv6，失败则降级到IPv4
- 连接策略：IPv6+IPv6 > IPv6+IPv4 > IPv4+IPv4

### 4. IP健康管理

- **白名单**：返回200的IP自动加入白名单
- **黑名单**：返回403的IP自动加入黑名单
- **自动恢复**：黑名单IP定期测试，恢复后自动移回白名单
- **ReturnConn 支持**：从连接的 RemoteAddr() 获取IP并更新黑白名单

### 5. 连接池管理

- **健康池**：优先使用，包含已验证可用的连接
- **不健康池**：备用，包含可能有问题但可尝试的连接
- **动态创建**：池为空时自动创建新连接（需要检查白名单）
- **空闲清理**：基于 lastUsed 时间戳自动清理超时连接

### 6. 并发安全

- 使用channel实现连接队列（并发安全）
- 使用RWMutex保护IP列表
- 使用WaitGroup管理后台任务

### 7. 资源管理

- 连接数限制：MaxConns控制最大连接数
- 空闲超时：IdleTimeout自动清理超时连接
- 优雅关闭：Close方法确保所有资源正确释放

## 使用示例

```go
// 1. 创建连接池
config := src.DomainConnPoolConfig{
    DomainMonitor:   domainMonitor,
    IPAccessControl: src.NewWhiteBlackIPPool(),
    LocalIPv4Pool:   localIPv4Pool,
    LocalIPv6Pool:   localIPv6Pool,
    Fingerprint:     fingerprint,
    Domain:          "example.com",
    Port:            "443",
    MaxConns:        100,
    IdleTimeout:     5 * time.Minute,
    WarmupPath:      "/",
    WarmupMethod:    "GET",
    WarmupHeaders:   make(map[string]string),
    WarmupConcurrency: 10,
    BlacklistTestInterval: 5 * time.Minute,
    IPRefreshInterval:     10 * time.Minute,
    DialTimeout:           10 * time.Second,
}

pool, err := src.NewDomainHotConnPool(config)
if err != nil {
    log.Fatalf("创建连接池失败: %v", err)
}
defer pool.Close()

// 2. 预热（测试所有IP，填充黑白名单）
if err := pool.Warmup(); err != nil {
    log.Printf("预热失败: %v", err)
}

// 3. 使用连接
conn, err := pool.GetConn()
if err != nil {
    log.Fatalf("获取连接失败: %v", err)
}

// 4. 使用连接发送HTTP请求
// ... 使用conn发送HTTP请求 ...

// 5. 归还连接（会根据状态码更新黑白名单）
statusCode := 200 // 从响应中获取
pool.ReturnConn(conn, statusCode)
```

## 状态转换图

```
IP状态转换：
    ┌─────────┐
    │  未知   │ (初始状态，白名单为空)
    └────┬────┘
         │
         │ 预热（跳过白名单检查）
         ↓
    ┌─────────┐      200      ┌─────────┐
    │  测试中  │ ────────────→ │  白名单  │
    └─────────┘                └────┬────┘
         │                          │
         │ 403                      │ 使用
         ↓                          ↓
    ┌─────────┐                ┌─────────┐
    │  黑名单  │                │  使用中  │
    └────┬────┘                └─────────┘
         │
         │ 定时测试
         │ 返回200
         ↓
    ┌─────────┐
    │  白名单  │ (恢复)
    └─────────┘

连接状态转换：
    ┌─────────┐
    │  创建   │
    └────┬────┘
         │
         │ 健康检查
         ↓
    ┌─────────┐      200      ┌──────────┐
    │  测试中  │ ────────────→ │ 健康连接池│
    └─────────┘                └────┬─────┘
         │                          │
         │ 403/错误                  │ GetConn
         ↓                          ↓
    ┌──────────┐               ┌─────────┐
    │不健康连接池│               │  使用中  │
    └────┬─────┘               └────┬────┘
         │                         │
         │ 定时清理                 │ ReturnConn
         │ (基于lastUsed)           │ (更新黑白名单)
         ↓                         ↓
    ┌─────────┐               ┌─────────┐
    │  关闭   │               │ 归还连接 │
    └─────────┘               └─────────┘
```

## 性能优化点

1. **连接复用**：优先使用池中的连接，减少创建开销
2. **并发预热**：使用信号量控制并发数，避免资源耗尽
3. **异步刷新**：后台任务异步更新IP列表，不阻塞主流程
4. **智能降级**：IPv6失败时自动降级，提高成功率
5. **健康管理**：自动管理IP健康状态，减少无效连接
6. **空闲清理**：自动清理超时连接，释放资源

## 注意事项

1. **预热阶段**：系统启动时白名单为空，预热会测试所有IP，不进行白名单过滤
2. **正常使用**：创建新连接时需要检查白名单，只有白名单中的IP才能创建连接
3. **连接协议匹配**：IPv4本地IP只能连接IPv4目标IP，IPv6本地IP优先连接IPv6目标IP
4. **黑白名单优先级**：黑名单优先于白名单，即使IP同时在两个名单中也会被拒绝
5. **连接超时**：连接创建和健康检查都有超时设置，避免长时间阻塞
6. **资源清理**：使用defer确保连接池正确关闭，避免资源泄漏
7. **并发安全**：所有共享状态都使用适当的锁保护
8. **IP追踪**：连接元数据包含目标IP，ReturnConn时可以更新黑白名单

