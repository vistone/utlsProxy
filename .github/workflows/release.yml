name: Auto Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip release]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史用于生成changelog
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: Get current version
        id: get_version
        run: |
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION)
          else
            CURRENT_VERSION=$(grep -E '^Version=' config/config.toml | sed 's/Version="\(.*\)"/\1/' | head -1)
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Bump version
        id: bump_version
        run: |
          CURRENT_VERSION="${{ steps.get_version.outputs.current }}"
          
          # 解析版本号
          VERSION=${CURRENT_VERSION#v}
          IFS='.' read -r major minor patch <<< "$VERSION"
          
          # 增加小版本号
          patch=$((patch + 1))
          NEW_VERSION="v${major}.${minor}.${patch}"
          
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
          
          # 更新VERSION文件
          echo "$NEW_VERSION" > VERSION
          
          # 更新config.toml
          sed -i "s/^Version=.*/Version=\"${NEW_VERSION}\"/" config/config.toml
      
      - name: Create Git tag
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add VERSION config/config.toml
          git commit -m "Bump version to $NEW_VERSION" || echo "No changes to commit"
          
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION

$COMMIT_MSG"
          
          git push origin main
          git push origin "$NEW_VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new }}"
          PREVIOUS_VERSION="${{ steps.get_version.outputs.current }}"
          
          # 获取两个版本之间的提交
          if git rev-parse "$PREVIOUS_VERSION" >/dev/null 2>&1; then
            COMMITS=$(git log --pretty=format:"- %s" ${PREVIOUS_VERSION}..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s" -10)
          fi
          
          CHANGELOG=$(cat <<EOF
          ## 版本 ${NEW_VERSION}
          
          ### 变更内容
          
          ${COMMITS}
          
          ### 详细变更
          
          查看完整提交历史: [Commits](https://github.com/${{ github.repository }}/compare/${PREVIOUS_VERSION}...${NEW_VERSION})
          
          ### 文档
          
          详细文档请查看 [docs/](docs/) 目录。
          EOF
          )
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.bump_version.outputs.new }}
          name: Release ${{ steps.bump_version.outputs.new }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

